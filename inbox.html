<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Gallery | Messages</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --light: #f8fafc;
            --dark: #1e293b;
            --card-bg: #ffffff;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow: 0 8px 30px rgba(0,0,0,0.08);
            --radius: 16px;
            --transition: all 0.3s ease;
            --message-sent: #3b82f6;
            --message-received: #f1f5f9;
        }

        [data-theme="dark"] {
            --light: #0f172a;
            --dark: #f8fafc;
            --card-bg: #1e293b;
            --secondary: #94a3b8;
            --message-received: #334155;
        }

        body {
            background: var(--light);
            color: var(--dark);
            transition: var(--transition);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--gradient);
            color: white;
            padding: 60px 40px;
            border-radius: var(--radius);
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        .back-btn {
            position: absolute;
            top: 25px;
            left: 25px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            color: white;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            z-index: 2;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .header h1 {
            font-size: 3.5rem;
            margin-bottom: 15px;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            font-weight: 500;
        }

        .inbox-container {
            display: flex;
            height: 70vh;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .conversations-sidebar {
            width: 400px;
            border-right: 1px solid var(--light);
            display: flex;
            flex-direction: column;
        }

        .conversations-header {
            padding: 25px;
            border-bottom: 1px solid var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversations-header h2 {
            color: var(--dark);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .new-conversation-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .new-conversation-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .conversations-search {
            padding: 20px;
            border-bottom: 1px solid var(--light);
        }

        .conversations-search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--light);
            border-radius: 25px;
            background: var(--light);
            color: var(--dark);
            font-size: 1rem;
            transition: var(--transition);
        }

        .conversations-search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--card-bg);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--light);
        }

        .conversation-item:hover {
            background: var(--light);
            transform: translateX(5px);
        }

        .conversation-item.active {
            background: var(--primary-light);
            color: white;
        }

        .conversation-item.active .conversation-name,
        .conversation-item.active .conversation-last-message {
            color: white;
        }

        .conversation-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            transition: var(--transition);
        }

        .conversation-item:hover .conversation-avatar {
            transform: scale(1.1);
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .verified-badge {
            color: var(--primary);
            font-size: 0.9rem;
        }

        .owner-badge {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .legendary-badge {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .conversation-last-message {
            color: var(--secondary);
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-meta {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .conversation-time {
            font-size: 0.85rem;
            color: var(--secondary);
            font-weight: 600;
        }

        .conversation-unread {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 25px;
            border-bottom: 1px solid var(--light);
            display: flex;
            align-items: center;
            gap: 20px;
            background: var(--card-bg);
        }

        .chat-user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }

        .chat-user-info {
            flex: 1;
        }

        .chat-user-name {
            font-weight: 700;
            color: var(--dark);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-user-status {
            color: var(--success);
            font-size: 0.95rem;
            font-weight: 600;
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            font-size: 1.3rem;
            transition: var(--transition);
            padding: 10px;
            border-radius: 50%;
        }

        .chat-action-btn:hover {
            color: var(--primary);
            background: var(--light);
            transform: scale(1.1);
        }

        .messages-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: var(--light);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            animation: messageSlide 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            background: var(--message-sent);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            align-self: flex-start;
            background: var(--message-received);
            color: var(--dark);
            border-bottom-left-radius: 5px;
        }

        .message.official {
            align-self: center;
            background: var(--gradient);
            color: white;
            max-width: 80%;
            text-align: center;
            border-radius: 15px;
            padding: 20px;
        }

        .message-text {
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 1rem;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            text-align: right;
            margin-top: 8px;
        }

        .message.received .message-time {
            text-align: left;
        }

        .message-input-container {
            padding: 25px;
            border-top: 1px solid var(--light);
            display: flex;
            gap: 15px;
            align-items: flex-end;
            background: var(--card-bg);
        }

        .message-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid var(--light);
            border-radius: 25px;
            background: var(--light);
            color: var(--dark);
            font-size: 1rem;
            resize: none;
            max-height: 120px;
            transition: var(--transition);
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--card-bg);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .send-btn:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            text-align: center;
            padding: 60px;
        }

        .empty-chat i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-chat h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .empty-chat p {
            font-size: 1.1rem;
            max-width: 400px;
            line-height: 1.6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
            max-height: 80vh;
            overflow: hidden;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary);
            transition: var(--transition);
            padding: 5px;
            border-radius: 50%;
        }

        .close-btn:hover {
            color: var(--error);
            background: var(--light);
            transform: rotate(90deg);
        }

        .user-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            border-bottom: 1px solid var(--light);
            transition: var(--transition);
            cursor: pointer;
            border-radius: var(--radius);
        }

        .user-item:hover {
            background: var(--light);
            transform: translateX(5px);
        }

        .user-avatar-list {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .user-bio {
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 18px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid rgba(255,255,255,0.3);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.info {
            background: var(--primary);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none !important;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .inbox-container {
                flex-direction: column;
                height: 80vh;
            }
            
            .conversations-sidebar {
                width: 100%;
                height: 40%;
            }
            
            .chat-area {
                height: 60%;
            }
            
            .message {
                max-width: 85%;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Home
            </a>

            <h1>AI Prompt Gallery</h1>
            <p>Connect with the creative community</p>
        </div>

        <div class="inbox-container">
            <div class="conversations-sidebar">
                <div class="conversations-header">
                    <h2>Messages</h2>
                    <button class="new-conversation-btn" id="newConversationBtn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <div class="conversations-search">
                    <input type="text" class="conversations-search-input" id="conversationsSearch" placeholder="Search conversations...">
                </div>
                
                <div class="conversations-list" id="conversationsList">
                    <div style="text-align: center; padding: 40px; color: var(--secondary);">
                        <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Loading conversations...</p>
                    </div>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="chat-header hidden" id="chatHeader">
                    <img src="" alt="User" class="chat-user-avatar" id="chatUserAvatar">
                    <div class="chat-user-info">
                        <div class="chat-user-name" id="chatUserName">
                            User Name
                            <i class="fas fa-check-circle verified-badge"></i>
                        </div>
                        <div class="chat-user-status" id="chatUserStatus">Online</div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="chat-action-btn">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="chat-action-btn">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="empty-chat">
                        <i class="fas fa-comments"></i>
                        <h3>No conversation selected</h3>
                        <p>Select a conversation from the sidebar or start a new one</p>
                    </div>
                </div>
                
                <div class="message-input-container hidden" id="messageInputContainer">
                    <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                    <button class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Conversation Modal -->
    <div class="modal" id="newConversationModal">
        <div class="modal-content">
            <button class="close-btn">&times;</button>
            <h2 style="margin-bottom: 20px; color: var(--dark); font-size: 1.8rem;">Start New Conversation</h2>
            
            <div class="conversations-search">
                <input type="text" class="conversations-search-input" id="userSearch" placeholder="Search users...">
            </div>
            
            <div class="user-list" id="userList">
                <div style="text-align: center; padding: 30px; color: var(--secondary);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Loading users...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDovL4QBUZfueYzMJpkCjWu_4NLMoQWyiA",
            authDomain: "gagsta-paradise.firebaseapp.com",
            projectId: "gagsta-paradise",
            storageBucket: "gagsta-paradise.firebasestorage.app",
            messagingSenderId: "78516691257",
            appId: "1:78516691257:web:466954e941fc6a7eb388e8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global Variables
        let currentUser = null;
        let currentConversation = null;
        let conversations = [];
        let users = {};
        let messageListener = null;
        const OWNER_EMAIL = "alizybaby381@gmail.com";
        const LEGENDARY_EMAIL = "ul8763325@gmail.com";
        const OFFICIAL_AI_USER_ID = "official_ai_prompt_gallery";

        // DOM Elements
        const elements = {
            newConversationModal: document.getElementById('newConversationModal'),
            newConversationBtn: document.getElementById('newConversationBtn'),
            conversationsList: document.getElementById('conversationsList'),
            messagesContainer: document.getElementById('messagesContainer'),
            messageInput: document.getElementById('messageInput'),
            messageInputContainer: document.getElementById('messageInputContainer'),
            sendBtn: document.getElementById('sendBtn'),
            userList: document.getElementById('userList'),
            chatHeader: document.getElementById('chatHeader'),
            chatUserAvatar: document.getElementById('chatUserAvatar'),
            chatUserName: document.getElementById('chatUserName'),
            chatUserStatus: document.getElementById('chatUserStatus')
        };

        // ✅ FIXED - Initialize App
        function initApp() {
            console.log('🚀 Initializing AI Prompt Gallery Messages...');
            setupEventListeners();
            initAuth();
        }

        // ✅ FIXED - Authentication System
        function initAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    console.log('✅ User signed in:', user.email);
                    await createOfficialAIUser();
                    await loadConversations();
                } else {
                    currentUser = null;
                    conversations = [];
                    updateConversationsList();
                    window.open('login.html', '_self');
                }
            });
        }

        // ✅ FIXED - Create Official AI Prompt Gallery User
        async function createOfficialAIUser() {
            try {
                const officialUserRef = db.collection('users').doc(OFFICIAL_AI_USER_ID);
                const officialUserDoc = await officialUserRef.get();
                
                if (!officialUserDoc.exists) {
                    await officialUserRef.set({
                        name: "AI Prompt Gallery",
                        email: "official@aipromptgallery.com",
                        avatar: "https://api.dicebear.com/7.x/bottts/svg?seed=AI&backgroundColor=667eea",
                        bio: "Welcome to our creative community! I'm here to help you get started with AI art and connect with other creators.",
                        isOfficial: true,
                        isVerified: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        followers: 0,
                        following: 0,
                        prompts: 0,
                        likes: 0
                    });
                    console.log('✅ Official AI User created');
                } else {
                    console.log('✅ Official AI User already exists');
                }
            } catch (error) {
                console.error('❌ Error creating official AI user:', error);
            }
        }

        // ✅ FIXED - Load Conversations
        async function loadConversations() {
            if (!currentUser) {
                showNotification('Please login to view messages', 'error');
                return;
            }

            try {
                console.log('🔄 Loading conversations for user:', currentUser.uid);
                
                // Show loading state
                elements.conversationsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--secondary);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>Loading conversations...</p>
                    </div>
                `;

                // ✅ Load conversations where user is participant
                const snapshot = await db.collection('conversations')
                    .where('participants', 'array-contains', currentUser.uid)
                    .orderBy('lastMessageAt', 'desc')
                    .get();

                conversations = [];
                snapshot.forEach(doc => {
                    conversations.push({
                        id: doc.id,
                        ...doc.data(),
                        lastMessage: doc.data().lastMessage || "Start a conversation",
                        lastMessageAt: doc.data().lastMessageAt || doc.data().createdAt || new Date()
                    });
                });

                console.log(`✅ Loaded ${conversations.length} conversations`);

                // Create welcome conversation if none exist
                if (conversations.length === 0) {
                    console.log('👋 Creating welcome conversation...');
                    await createWelcomeConversation();
                    return;
                }

                await loadParticipantsData();
                updateConversationsList();

            } catch (error) {
                console.error('❌ Error loading conversations:', error);
                showNotification('Failed to load conversations', 'error');
                
                elements.conversationsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--secondary);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>Failed to load conversations</p>
                        <button onclick="loadConversations()" style="margin-top: 15px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }

        // ✅ FIXED - Create Welcome Conversation with Official AI (FROM OFFICIAL ACCOUNT)
        async function createWelcomeConversation() {
            try {
                const conversationData = {
                    participants: [currentUser.uid, OFFICIAL_AI_USER_ID],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: "Welcome to AI Prompt Gallery! 🎨",
                    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isWelcome: true
                };

                const conversationRef = await db.collection('conversations').add(conversationData);

                // Add welcome message from Official AI (NOT from user)
                await db.collection('conversations').doc(conversationRef.id)
                    .collection('messages').add({
                        text: `🎨 Welcome to AI Prompt Gallery, ${currentUser.displayName || 'friend'}!\n\nI'm your official AI assistant here to help you:\n\n• Discover amazing AI art prompts\n• Connect with creative artists\n• Share your own creations\n• Learn prompt engineering\n\nStart by exploring prompts or upload your first creation! What would you like to create today? ✨`,
                        senderId: OFFICIAL_AI_USER_ID, // This should be OFFICIAL AI ID, not user ID
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        isOfficial: true
                    });

                console.log('✅ Welcome conversation created with Official AI');
                
                // Reload conversations
                await loadConversations();
                
            } catch (error) {
                console.error('❌ Error creating welcome conversation:', error);
            }
        }

        // ✅ FIXED - Load Participants Data
        async function loadParticipantsData() {
            try {
                const allUserIds = new Set([OFFICIAL_AI_USER_ID]);
                
                conversations.forEach(conv => {
                    conv.participants.forEach(uid => {
                        if (uid !== currentUser.uid) allUserIds.add(uid);
                    });
                });

                // Load official AI user first
                const officialUserDoc = await db.collection('users').doc(OFFICIAL_AI_USER_ID).get();
                if (officialUserDoc.exists) {
                    users[OFFICIAL_AI_USER_ID] = officialUserDoc.data();
                }

                // Load other users
                for (let uid of allUserIds) {
                    if (uid === OFFICIAL_AI_USER_ID) continue;
                    
                    try {
                        const userDoc = await db.collection('users').doc(uid).get();
                        if (userDoc.exists) {
                            users[uid] = userDoc.data();
                        } else {
                            // If user document doesn't exist, create a basic one
                            users[uid] = {
                                name: "User",
                                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${uid}`,
                                bio: "AI Artist",
                                email: "user@example.com"
                            };
                        }
                    } catch (error) {
                        console.log('User not found:', uid);
                        users[uid] = {
                            name: "User",
                            avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${uid}`,
                            bio: "AI Artist",
                            email: "user@example.com"
                        };
                    }
                }

            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }

        // ✅ FIXED - Update Conversations List UI
        function updateConversationsList() {
            if (!currentUser) {
                elements.conversationsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--secondary);">
                        <i class="fas fa-sign-in-alt" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>Please login to view messages</p>
                    </div>
                `;
                return;
            }
            
            if (conversations.length === 0) {
                elements.conversationsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--secondary);">
                        <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>No conversations yet</p>
                        <button class="new-conversation-btn" onclick="openNewConversationModal()" style="margin-top: 15px; background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">
                            <i class="fas fa-plus"></i> Start New Chat
                        </button>
                    </div>
                `;
                return;
            }
            
            elements.conversationsList.innerHTML = conversations.map(conv => {
                const otherUserId = conv.participants.find(uid => uid !== currentUser.uid);
                const otherUser = users[otherUserId] || {
                    name: 'User',
                    avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${otherUserId}`,
                    email: 'user@example.com'
                };

                const lastMessage = conv.lastMessage || 'Start a conversation';
                const lastMessageTime = conv.lastMessageAt ? formatTime(conv.lastMessageAt.toDate()) : '';

                // ✅ VERIFIED TICK - ONLY FOR SPECIFIC USERS
                const isOwner = otherUser.email === OWNER_EMAIL;
                const isLegendary = otherUser.email === LEGENDARY_EMAIL;
                const isOfficial = otherUser.isOfficial;

                return `
                    <div class="conversation-item ${currentConversation?.id === conv.id ? 'active' : ''}" 
                         data-conversation-id="${conv.id}">
                        <img src="${otherUser.avatar}" alt="${otherUser.name}" class="conversation-avatar">
                        <div class="conversation-info">
                            <div class="conversation-name">
                                ${otherUser.name}
                                ${(isOwner || isLegendary || isOfficial) ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}
                                ${isOwner ? '<span class="owner-badge">Owner</span>' : ''}
                                ${isLegendary ? '<span class="legendary-badge">Legendary</span>' : ''}
                                ${isOfficial ? '<span class="owner-badge">Official</span>' : ''}
                            </div>
                            <div class="conversation-last-message">${lastMessage}</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">${lastMessageTime}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click listeners
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', () => {
                    const conversationId = item.dataset.conversationId;
                    selectConversation(conversationId);
                });
            });
        }

        // ✅ FIXED - Select Conversation with Real-time Updates
        async function selectConversation(conversationId) {
            if (!currentUser) return;
            
            // Stop previous listener
            if (messageListener) {
                messageListener();
            }
            
            currentConversation = conversations.find(conv => conv.id === conversationId);
            if (!currentConversation) return;
            
            console.log('💬 Selecting conversation:', conversationId);
            
            // Update active state
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.toggle('active', item.dataset.conversationId === conversationId);
            });
            
            // Show chat UI
            elements.chatHeader.classList.remove('hidden');
            elements.messageInputContainer.classList.remove('hidden');
            
            const otherUserId = currentConversation.participants.find(uid => uid !== currentUser.uid);
            const otherUser = users[otherUserId] || { 
                name: 'User', 
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${otherUserId}`,
                email: 'user@example.com'
            };
            
            // Update chat header
            elements.chatUserAvatar.src = otherUser.avatar;
            
            const isOwner = otherUser.email === OWNER_EMAIL;
            const isLegendary = otherUser.email === LEGENDARY_EMAIL;
            const isOfficial = otherUser.isOfficial;
            
            elements.chatUserName.innerHTML = `
                ${otherUser.name}
                ${(isOwner || isLegendary || isOfficial) ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}
                ${isOwner ? '<span class="owner-badge">Owner</span>' : ''}
                ${isLegendary ? '<span class="legendary-badge">Legendary</span>' : ''}
                ${isOfficial ? '<span class="owner-badge">Official</span>' : ''}
            `;
            elements.chatUserStatus.textContent = isOfficial ? 'Always Online' : 'Online';
            
            // Load messages with real-time listener
            await loadMessages(conversationId);
            
            // Set up real-time listener for new messages
            setupMessageListener(conversationId);
        }

        // ✅ FIXED - Set up Real-time Message Listener
        function setupMessageListener(conversationId) {
            messageListener = db.collection('conversations').doc(conversationId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                    
                    displayMessages(messages);
                    
                    // Update conversation in sidebar if this is the active conversation
                    if (currentConversation && currentConversation.id === conversationId && messages.length > 0) {
                        const lastMessage = messages[messages.length - 1];
                        updateConversationLastMessage(conversationId, lastMessage.text, lastMessage.timestamp);
                    }
                }, error => {
                    console.error('Error in message listener:', error);
                });
        }

        // ✅ FIXED - Update Conversation Last Message
        function updateConversationLastMessage(conversationId, message, timestamp) {
            const conversation = conversations.find(conv => conv.id === conversationId);
            if (conversation) {
                conversation.lastMessage = message.length > 50 ? message.substring(0, 50) + '...' : message;
                conversation.lastMessageAt = timestamp;
                updateConversationsList();
            }
        }

        // ✅ FIXED - Load Messages
        async function loadMessages(conversationId) {
            try {
                const snapshot = await db.collection('conversations').doc(conversationId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .get();
                
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                displayMessages(messages);
                
            } catch (error) {
                console.error('❌ Error loading messages:', error);
                showNotification('Failed to load messages', 'error');
            }
        }

        // ✅ FIXED - Display Messages
        function displayMessages(messages) {
            if (messages.length === 0) {
                elements.messagesContainer.innerHTML = `
                    <div class="empty-chat">
                        <i class="fas fa-comment-slash"></i>
                        <h3>No messages yet</h3>
                        <p>Start the conversation by sending a message</p>
                    </div>
                `;
                return;
            }
            
            elements.messagesContainer.innerHTML = messages.map(message => {
                const isSent = message.senderId === currentUser.uid;
                const isOfficial = message.isOfficial;
                const time = message.timestamp ? formatTime(message.timestamp.toDate()) : '';
                
                if (isOfficial) {
                    return `
                        <div class="message official">
                            <div class="message-text">${message.text}</div>
                            <div class="message-time">${time}</div>
                        </div>
                    `;
                }
                
                return `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // ✅ FIXED - Send Message with Security Check
        async function sendMessage() {
            if (!currentUser || !currentConversation || !elements.messageInput.value.trim()) return;
            
            // Security check - verify user is participant in conversation
            if (!currentConversation.participants.includes(currentUser.uid)) {
                showNotification('You are not authorized to send messages in this conversation', 'error');
                return;
            }
            
            const messageText = elements.messageInput.value.trim();
            
            try {
                // Add message to Firestore
                await db.collection('conversations').doc(currentConversation.id).collection('messages').add({
                    text: messageText,
                    senderId: currentUser.uid, // This should be current user's ID
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });
                
                // Update conversation last message
                await db.collection('conversations').doc(currentConversation.id).update({
                    lastMessage: messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText,
                    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Clear input
                elements.messageInput.value = '';
                elements.messageInput.style.height = 'auto';
                
            } catch (error) {
                console.error('❌ Error sending message:', error);
                showNotification('Error sending message', 'error');
            }
        }

        // ✅ FIXED - New Conversation Modal (FIXED USER LOADING)
        async function openNewConversationModal() {
            if (!currentUser) {
                showNotification('Please login to start a conversation', 'error');
                return;
            }
            
            try {
                openModal(elements.newConversationModal);
                
                // Show loading
                elements.userList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--secondary);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Loading users...</p>
                    </div>
                `;

                // ✅ FIXED - Load all users except current user and official AI
                const snapshot = await db.collection('users').get();
                
                const allUsers = [];
                snapshot.forEach(doc => {
                    // Exclude current user, official AI, and users without proper data
                    if (doc.id !== currentUser.uid && 
                        doc.id !== OFFICIAL_AI_USER_ID && 
                        doc.data().email && 
                        doc.data().name !== "User") {
                        const userData = doc.data();
                        allUsers.push({ 
                            id: doc.id, 
                            ...userData
                        });
                    }
                });

                console.log(`✅ Loaded ${allUsers.length} users for new conversation`);

                if (allUsers.length === 0) {
                    elements.userList.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--secondary);">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>No other users found yet</p>
                            <small>Tell your friends to join AI Prompt Gallery!</small>
                        </div>
                    `;
                } else {
                    elements.userList.innerHTML = allUsers.map(user => {
                        const isOwner = user.email === OWNER_EMAIL;
                        const isLegendary = user.email === LEGENDARY_EMAIL;
                        
                        return `
                            <div class="user-item" data-user-id="${user.id}">
                                <img src="${user.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.id}`}" 
                                     alt="${user.name}" class="user-avatar-list">
                                <div class="user-info">
                                    <div class="user-name">
                                        ${user.name || 'User'}
                                        ${(isOwner || isLegendary) ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}
                                        ${isOwner ? '<span class="owner-badge">Owner</span>' : ''}
                                        ${isLegendary ? '<span class="legendary-badge">Legendary</span>' : ''}
                                    </div>
                                    <div class="user-bio">${user.bio || 'AI Art Enthusiast'}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Add click listeners
                document.querySelectorAll('.user-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const userId = item.dataset.userId;
                        startNewConversation(userId);
                    });
                });
                
            } catch (error) {
                console.error('❌ Error loading users:', error);
                elements.userList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--secondary);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Unable to load users</p>
                        <small>Please check your internet connection</small>
                        <button onclick="openNewConversationModal()" style="margin-top: 15px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }

        // ✅ FIXED - Start New Conversation
        async function startNewConversation(otherUserId) {
            if (!currentUser) return;
            
            try {
                // Check if conversation already exists
                const existingConversation = conversations.find(conv => 
                    conv.participants.includes(otherUserId) && 
                    conv.participants.includes(currentUser.uid)
                );
                
                if (existingConversation) {
                    closeModal(elements.newConversationModal);
                    selectConversation(existingConversation.id);
                    showNotification('Conversation already exists', 'info');
                    return;
                }
                
                // Create new conversation
                const conversationData = {
                    participants: [currentUser.uid, otherUserId],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: 'Conversation started',
                    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const conversationRef = await db.collection('conversations').add(conversationData);
                
                // Add first message FROM CURRENT USER (not from official account)
                await db.collection('conversations').doc(conversationRef.id)
                    .collection('messages').add({
                        text: `Hello! I'd like to connect with you about AI art prompts. 👋`,
                        senderId: currentUser.uid, // This should be current user's ID
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false
                    });
                
                closeModal(elements.newConversationModal);
                showNotification('New conversation started!', 'success');
                
                // Reload conversations
                await loadConversations();
                
            } catch (error) {
                console.error('❌ Error starting new conversation:', error);
                showNotification('Error starting conversation', 'error');
            }
        }

        // ✅ FIXED - Event Listeners
        function setupEventListeners() {
            elements.newConversationBtn.addEventListener('click', openNewConversationModal);
            elements.sendBtn.addEventListener('click', sendMessage);
            
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            elements.messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal');
                    closeModal(modal);
                });
            });
            
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target);
                }
            });
        }

        // ✅ FIXED - Utility Functions
        function formatTime(date) {
            if (!date) return '';
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return date.toLocaleDateString([], { weekday: 'short' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }

        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(notif => notif.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        function openModal(modal) {
            modal.style.display = 'block';
        }

        function closeModal(modal) {
            modal.style.display = 'none';
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
